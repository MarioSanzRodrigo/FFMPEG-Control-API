<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>MediaProcessors: codecs_muxers_loopback_example.md Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MediaProcessors
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">codecs_muxers_loopback_example.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;# </div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;codecs_muxers_loopback example</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;==============================</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;The example source code: codecs_muxers_loopback.c</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;This example implements a full video coding and muxing loopback path:</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;- Server side:</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;      - generates a video raw source;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;      - encodes the video source (in one of the following: H.264, MPEG2-video or MLHE);</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;      - multiplex the video encoded elementary stream in RTSP session;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;- Client side:</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;       - de-multiplex video elementary stream;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;       - decodes the video;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;       - renders the video in a frame buffer.</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;The flow scheme in the codecs_muxers_loopback example is similar to the one shown in [figure 2](md_DOCUMENTATION.html#How_to_use_a_Processor_the_API), but with the following modified thread scheme:</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;- Server side:</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;      - A &#39;producer thread&#39; generates raw video and sends raw YUV frames to the video encoder;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;      - A &#39;multiplexer thread&#39; receives encoded frames from video encoder and sends to the multiplexer (that is, to the remote client using the RTSP session);</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;      - The main thread is used to execute the HTTP server listening loop (until an application interruption signal -&quot;ctrl+c&quot;- is recieved)</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;- Client side:</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;      - A &#39;de-multiplexer thread&#39; receives the encoded frames from the RTSP connection, and sends to the video decoder;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;      - A &#39;consumer thread&#39; finally reads the raw video frame from the decoder and renders (using the 3rd party library SDL2).</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;#### Initializing application and video codecs</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;Apply the same general considerations explained at [the API documentation](md_DOCUMENTATION.html#How_to_use_a_Processor_the_API), that is (application epilogue):</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;-# Initialize (open) the processors (PROCS) module (this is done by calling function &#39;procs_module_open()&#39;);</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;-# Register the processor types we support in the application (performed using the operation &#39;PROCS_REGISTER_TYPE&#39; provided through the function &#39;procs_module_opt()&#39;);</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;-# Create (open) an instance of the PROCS module (using the function &#39;procs_open()&#39; which returns an instance handler);</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;-# Creates specific processors instances (using the operation &#39;PROCS_POST&#39; with the function &#39;procs_opt()&#39;; a unique processor identifier is supplied for each instance):</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;         - Create a video encoder instance</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;         - Create a video decoder instance</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;         - Create a RTSP multiplexor instance</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;         - Create a RTSP de-multiplexor instance</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;But, there are important new considerations on initializing and handling the multiplexer and demultiplexer processors.&lt;br&gt;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;Let&#39;s have an insight on this in the next subsections.</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;#### Initializing the multiplexer</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;After instantiating the multiplexer, we must register all the elementary streams we will be serving (in this example only a video stream is served, but we may add other video or audio streams).&lt;br&gt;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;This is done using the following API call:</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;@code</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;ret_code= procs_opt(procs_ctx, &quot;PROCS_ID_ES_MUX_REGISTER&quot;, mux_proc_id, mime_setting, &amp;rest_str);</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;@endcode</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;If succeed, the &lt;b&gt;elementary stream identifier&lt;/b&gt; will be returned in a JSON of the form:</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;@code</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;{&quot;elementary_stream_id&quot;:number}</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;@endcode</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;The elementary stream Id. is essential to the multiplexer, as is a unique number used to discriminate to which of the multiplexed streams an input frame is to be sent.</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;#### Handling the multiplexer</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;This is imeplemented in the code of the multiplexer thread (function &#39;mux_thr()&#39;).</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;The important detail to remark is that &lt;b&gt;the elementary stream Id. must be specified in the input frame using the proc_frame_ctx_s::es_id field&lt;/b&gt;.</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;@code</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;proc_frame_ctx-&gt;es_id= thr_ctx-&gt;elem_strem_id_video_server;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;ret_code= procs_send_frame(thr_ctx-&gt;procs_ctx, thr_ctx-&gt;mux_proc_id, proc_frame_ctx);</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;@endcode</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;If more than one source is used (e.g. video and audio), you must use the corresponding elementary stream Id. for sending the frames of each source.</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;#### Initializing the de-multiplexer</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;The RTSP client must be provided with the listening URL in the instantiation (e.g. &quot;rtsp_url=rtsp://127.0.0.1:8574/session&quot;).</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;#### Handling the de-multiplexer</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;The demultiplexer does not know at first instance how many sources are carried in a session. Thus, when establishing the session -that is, receiving the first frame-, the de-multiplexer API should be used to know the elementary streams carried and the identifiers assigned to each one. It is important to remark that the elementary streams identifiers used at the multiplexer are decoupled of the ones used at the de-multiplexer (in fact, in the case of the RTSP implementation, the de-multiplexer uses the service port as the Id., and the multiplexer use an incrementing counter).&lt;br&gt;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;We ask then for the state of the demutiplexer when receiving the first frame (see de-multiplexer thread function &#39;dmux_thr()&#39;):</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;@code</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    ret_code= procs_opt(thr_ctx-&gt;procs_ctx, &quot;PROCS_ID_GET&quot;,</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;            thr_ctx-&gt;dmux_proc_id, &amp;rest_str);</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;@endcode</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;The answer will be of the form:</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;@code</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;{</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;   &quot;settings&quot;:{</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      &quot;rtsp_url&quot;:&quot;rtsp://127.0.0.1:8574/session&quot;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;   },</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;   &quot;elementary_streams&quot;:[</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;      {</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;         &quot;sdp_mimetype&quot;:&quot;video/MP2V&quot;,</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;         &quot;port&quot;:59160,</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;         &quot;elementary_stream_id&quot;:59160</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;      }</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;   ]</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;}</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;@endcode</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;This response should be parsed to obtain the elementary stream Id. It should be used to know to which decoder/processor to send each received frame (the stream identifier will be specified in the proc_frame_ctx_s::es_id fied of the received frame) (In this example, we just have one video stream so all the frames received from the demultiplexer should have the same stream Id.).</div></div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
